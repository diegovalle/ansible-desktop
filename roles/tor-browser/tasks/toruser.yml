- name: install iptables-persistent
  apt: pkg=iptables-persistent state=present update_cache=true
  notify:
    - start iptables-persistent

# Add user

- name: Add the user 'anon'
  user:
    name: tor
    groups: audio
    shell: /bin/bash
    append: yes
    uid: 1634
    state: present

# Iptables

- name: Only tor
  shell: iptables -t nat -A OUTPUT -m owner --uid-owner 1634 -p tcp -j REDIRECT --to-ports 9040

- name: Only tor
  shell: iptables -t nat -A OUTPUT -m owner --uid-owner 1634 -p tcp -j REDIRECT --to-ports 9040

- name: Only tor
  shell: iptables -t nat -A OUTPUT -m owner --uid-owner 1634 -p udp --dport 53 -j REDIRECT --to-ports 5300

- name: Only tor
  shell: iptables        -A OUTPUT -m owner --uid-owner 1634 -p udp -d 127.0.0.1 --dport 5300 -j ACCEPT
  
- name: Only tor
  shell: iptables        -A OUTPUT -m owner --uid-owner 1634 -j REJECT

- name: save rules
  shell: netfilter-persistent save

- name: ensure iptables-persistent restarted
  service: name=netfilter-persistent state=restarted

# Tor

- name: tor package
  package:
    name: tor
    state: present

- name: configure tor to resolve onion hostnames
  blockinfile:
    path: /etc/tor/torrc
    owner: root
    group: root
    mode: 0644
    block: |
      TransPort 9040
      DNSPort 5300
      AutomapHostsOnResolve 1

- name: ensure tor is running
  service: name=tor state=started
